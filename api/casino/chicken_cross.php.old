<?php
header('Content-Type: application/json');
require_once __DIR__ . '/../../includes/functions.php';
require_once __DIR__ . '/../../includes/db.php';

secure_session_start();
require_login();

$user_id = get_current_user_id();
$input = json_decode(file_get_contents('php://input'), true);
$action = $input['action'] ?? '';

if ($action === 'start') {
    $bet = floatval($input['bet'] ?? 0);
    
    if ($bet < 0.10 || $bet > 100) {
        echo json_encode(['status' => 'error', 'error' => 'Ungültiger Einsatz']);
        exit;
    }
    
    // Get balance
    $stmt = $conn->prepare("SELECT v.balance FROM users u LEFT JOIN v_member_balance v ON u.username = v.username WHERE u.id = ?");
    $stmt->bind_param('i', $user_id);
    $stmt->execute();
    $stmt->bind_result($balance);
    $stmt->fetch();
    $stmt->close();
    
    $available = max(0, floatval($balance ?? 0) - 10.00);
    
    if ($bet > $available) {
        echo json_encode(['status' => 'error', 'error' => 'Nicht genug Guthaben']);
        exit;
    }
    
    // Initialize game session
    $_SESSION['chicken_game'] = [
        'bet' => $bet,
        'crossed' => 0,
        'total_streets' => 10,
        'survival_rate' => 0.8
    ];
    
    echo json_encode(['status' => 'success']);
    exit;
}

if ($action === 'cross') {
    if (!isset($_SESSION['chicken_game'])) {
        echo json_encode(['status' => 'error', 'error' => 'Kein aktives Spiel']);
        exit;
    }
    
    $game = $_SESSION['chicken_game'];
    $road = intval($input['road'] ?? -1);
    
    if ($road < 0 || $road >= 10) {
        echo json_encode(['status' => 'error', 'error' => 'Ungültige Straße']);
        exit;
    }
    
    // Check if hit by car (20% chance)
    $random = mt_rand() / mt_getrandmax();
    
    if ($random >= $game['survival_rate']) {
        // Hit by car
        unset($_SESSION['chicken_game']);
        
        // Save loss
        $stmt = $conn->prepare("INSERT INTO casino_history (user_id, game_type, bet_amount, win_amount) VALUES (?, 'chicken', ?, 0)");
        $stmt->bind_param('id', $user_id, $game['bet']);
        $stmt->execute();
        $stmt->close();
        
        echo json_encode(['status' => 'hit']);
        exit;
    }
    
    // Safe!
    $game['crossed']++;
    $_SESSION['chicken_game'] = $game;
    
    // Calculate multiplier: (1 - house_edge) / survival_rate^crossed
    $house_edge = 0.05;
    $multiplier = (1 - $house_edge) / pow($game['survival_rate'], $game['crossed']);
    $potential_win = $game['bet'] * $multiplier;
    
    echo json_encode([
        'status' => 'safe',
        'crossed' => $game['crossed'],
        'multiplier' => round($multiplier, 2),
        'potential_win' => round($potential_win, 2)
    ]);
    exit;
}

if ($action === 'cashout') {
    if (!isset($_SESSION['chicken_game'])) {
        echo json_encode(['status' => 'error', 'error' => 'Kein aktives Spiel']);
        exit;
    }
    
    $game = $_SESSION['chicken_game'];
    
    if ($game['crossed'] === 0) {
        echo json_encode(['status' => 'error', 'error' => 'Mindestens 1 Straße überqueren']);
        exit;
    }
    
    $house_edge = 0.05;
    $multiplier = (1 - $house_edge) / pow($game['survival_rate'], $game['crossed']);
    $win_amount = $game['bet'] * $multiplier;
    
    // Save win
    $stmt = $conn->prepare("INSERT INTO casino_history (user_id, game_type, bet_amount, win_amount, multiplier) VALUES (?, 'chicken', ?, ?, ?)");
    $stmt->bind_param('iddd', $user_id, $game['bet'], $win_amount, $multiplier);
    $stmt->execute();
    $stmt->close();
    
    // Add to balance
    $stmt = $conn->prepare("SELECT id FROM users WHERE id = ?");
    $stmt->bind_param('i', $user_id);
    $stmt->execute();
    $stmt->bind_result($mitglied_id);
    $stmt->fetch();
    $stmt->close();
    
    if ($mitglied_id) {
        $profit = $win_amount - $game['bet'];
        $typ = 'EINZAHLUNG';
        $description = "Casino Chicken Gewinn (" . round($multiplier, 2) . "x)";
        $stmt = $conn->prepare("INSERT INTO transaktionen (typ, betrag, mitglied_id, beschreibung, erstellt_von) VALUES (?, ?, ?, ?, ?)");
        $stmt->bind_param('sdisi', $typ, $profit, $mitglied_id, $description, $user_id);
        $stmt->execute();
        $stmt->close();
    }
    
    unset($_SESSION['chicken_game']);
    
    // Get new balance
    $stmt = $conn->prepare("SELECT v.balance FROM users u LEFT JOIN v_member_balance v ON u.username = v.username WHERE u.id = ?");
    $stmt->bind_param('i', $user_id);
    $stmt->execute();
    $stmt->bind_result($new_balance);
    $stmt->fetch();
    $stmt->close();
    
    echo json_encode([
        'status' => 'success',
        'win' => round($win_amount, 2),
        'multiplier' => round($multiplier, 2),
        'new_balance' => max(0, floatval($new_balance ?? 0) - 10.00)
    ]);
    exit;
}

echo json_encode(['status' => 'error', 'error' => 'Ungültige Aktion']);
